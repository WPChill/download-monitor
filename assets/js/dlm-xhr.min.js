jQuery(function(e){new DLM_XHR_Download});class DLM_XHR_Download{xhrNonce=!1;constructor(){(dlmXHRinstance=this).init()}init(){dlmXHRinstance.attachButtonEvent()}attachButtonEvent(){jQuery("html, body").on("click",".dlm-no-access-modal-overlay, .dlm-no-access-modal-close",function(e){jQuery("#dlm-no-access-modal").remove()}),jQuery("html, body").on("click","a",function(e){const d=jQuery(this).attr("href");let o=!1;jQuery(this).hasClass("dlm-no-xhr-download")&&(o=!0),"undefined"!=typeof dlmNonXHRGlobalLinks&&0<dlmNonXHRGlobalLinks.length&&void 0!==d&&dlmNonXHRGlobalLinks.forEach(e=>{0<=d.indexOf(e)&&(o=!0)}),o?jQuery("#dlm-no-access-modal").remove():void 0!==d&&0<=d.indexOf(dlmXHRGlobalLinks)&&dlmXHRinstance.handleDownloadClick(this,e)})}handleDownloadClick(e,d){d.stopPropagation();var o=e.getAttribute("href");let t={button:e,href:o,buttonObj:jQuery(e)};-1===t.href.indexOf("blob:http")&&"#"!==t.href&&(d.preventDefault(),dlmXHRinstance.retrieveBlob(t))}retrieveBlob(e){const x=this;let{button:f,href:h,buttonObj:w}=e,g;dlmXHRinstance.request=new XMLHttpRequest;const b=dlmXHR.prevent_duplicates,R=w.attr("target");let H=w.attr("class");H=void 0!==H&&""!==H?H.replace("dlm-download-started","").replace("dlm-download-completed",""):"",w.addClass("dlm-download-started"),f.setAttribute("href","#"),f.removeAttribute("download"),f.setAttribute("disabled","disabled");e='<img src="'+dlmXHRgif+'" class="dlm-xhr-loading-gif" style="display:inline-block; vertical-align: middle; margin-left:15px;">';f.innerHTML+=e,jQuery(document).trigger("dlm_download_triggered",[this,f,w,g,dlmXHRinstance.request]),dlmXHRinstance.request.responseType="blob",dlmXHRinstance.request.onreadystatechange=function(){var{status:e,readyState:d,statusText:o}=dlmXHRinstance.request;let t=dlmXHRinstance.request.getAllResponseHeaders().split("\r\n").reduce((e,d)=>{var[d,o]=d.split(": ");return e[d]=o,e},{}),l=(x.xhrNonce=t["x-dlm-nonce"],"download"),n=!1,r=!1,s=!1,a=!1,i=null,m=!1,c=!1,u=!1,v=!1,p=!1;if(void 0!==t["dlm-file-name"]&&(n=t["dlm-file-name"]),void 0!==t["dlm-no-waypoints"]&&(r=!0),void 0!==t["dlm-redirect"]&&(s=t["dlm-redirect"]),void 0!==t["dlm-external-download"]&&(a=!0),void 0!==t["dlm-no-access"]&&(i=t["dlm-no-access"]),void 0!==t["dlm-no-access-modal"]&&(m=t["dlm-no-access-modal"]),void 0!==t["dlm-error"]&&(c=t["dlm-error"]),void 0!==t["dlm-download-id"]&&(u=t["dlm-download-id"]),void 0!==t["dlm-version-id"]&&(v=t["dlm-version-id"]),void 0!==t["dlm-no-access-modal-text"]&&(p=t["dlm-no-access-modal-text"]),void 0!==t["x-dlm-file-name"]&&(n=t["x-dlm-file-name"]),void 0!==t["x-dlm-no-waypoints"]&&(r=!0),void 0!==t["x-dlm-redirect"]&&(s=t["x-dlm-redirect"]),void 0!==t["x-dlm-external-download"]&&(a=!0),void 0!==t["x-dlm-no-access"]&&(i=t["x-dlm-no-access"]),void 0!==t["x-dlm-no-access-modal"]&&(m=t["x-dlm-no-access-modal"]),void 0!==t["x-dlm-error"]&&(c=t["x-dlm-error"]),void 0!==t["x-dlm-download-id"]&&(u=t["x-dlm-download-id"]),void 0!==t["x-dlm-version-id"]&&(v=t["x-dlm-version-id"]),void 0!==t["x-dlm-no-access-modal-text"]&&(p=t["x-dlm-no-access-modal-text"]),n?(l=n.replace(/\"/g,"").replace(";",""),l=decodeURI(l)):void 0!==t["content-disposition"]&&(l=(l=t["content-disposition"].split(/(?:filename\*=UTF-8'')|(?:filename=)/)[1]).replace(/\"/g,"").replace(";",""),l=decodeURI(l)),2===dlmXHRinstance.request.readyState){if(void 0!==t["x-dlm-force-abort"]&&""!==t["x-dlm-force-abort"])return f.removeAttribute("download"),f.setAttribute("href",h),w.removeClass().addClass(H).find("span.dlm-xhr-progress").remove(),w.find(".dlm-xhr-loading-gif").remove(),dlmXHRinstance.request.abort(),void jQuery("#dlm-no-access-modal").remove();if(r)return dlmXHRinstance.request.abort(),s?void(window.location.href=s):void(window.location.href=h);if(a)return dlmXHRinstance.request.abort(),void dlmXHRinstance.dlmExternalDownload(t,f,w,l,h);if(0===Object.keys(t).filter(e=>-1!==e.indexOf("dlm-")).length)return dlmXHRinstance.request.abort(),void(window.location.href=h);if(i&&"true"===i&&m&&0!=m)return dlmXHRinstance.dlmNoAccessModal(t),f.removeAttribute("download"),f.setAttribute("href",h),w.removeClass().addClass(H).find("span.dlm-xhr-progress").remove(),w.find(".dlm-xhr-loading-gif").remove(),void dlmXHRinstance.request.abort();if(c&&""!==c&&null!==c)return dlmXHRinstance.dlmLogDownload(t,"failed",!1),f.removeAttribute("download"),f.setAttribute("href",h),w.removeClass().addClass(H).find("span.dlm-xhr-progress").remove(),w.find(".dlm-xhr-loading-gif").remove(),dlmXHRinstance.request.abort(),void(m&&0!=m?dlmXHRinstance.dlmNoAccessModal(u,v,p):(w.find(".dlm-xhr-error").remove(),w.append('<span class="dlm-xhr-error">'+c+"</span>")));if(s&&""!==s&&null!==s)return dlmXHRinstance.dlmLogDownload(t,"redirected",!1,s,i,R),f.removeAttribute("download"),f.setAttribute("href",h),w.removeClass().addClass(H).find("span.dlm-xhr-progress").remove(),w.find(".dlm-xhr-loading-gif").remove(),void dlmXHRinstance.request.abort()}if(404==e&&2==d){let e=document.createElement("p");e.innerHTML=o,f.parentNode.appendChild(e)}if(401==e&&2==d)window.location.href=o;else{if(403==e&&2==d){let e=document.createElement("p");e.innerHTML=o,f.parentNode.appendChild(e)}200==e&&4==d&&(o=dlmXHRinstance.request.response,g=URL.createObjectURL(o),f.removeEventListener("click",dlmXHRinstance.handleDownloadClick),f.setAttribute("download",""+l),f.setAttribute("href",g),f.click(),w.removeClass().addClass(H+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,f,w,g]),dlmXHRinstance.dlmLogDownload(t,"completed",b),window.URL.revokeObjectURL(g),f.removeAttribute("download"),f.setAttribute("href",h),w.find(".dlm-xhr-loading-gif").remove(),setTimeout(function(){w.removeClass().addClass(H).find("span.dlm-xhr-progress").remove()},4e3))}},dlmXHRinstance.request.addEventListener("progress",function(e){let d=e.loaded/e.total*100;d=d.toFixed();var o;w.find("span.dlm-xhr-progress").remove(),o="dlm-download-started download-"+10*Math.ceil(d/10),1/0!=d&&w.append('<span class="dlm-xhr-progress">&nbsp;'+d+"%</span>"),w.removeClass().addClass(H+" "+o),jQuery(document).trigger("dlm_download_progress",[this,f,w,g,e,d])}),dlmXHRinstance.request.onerror=function(){f.removeAttribute("download"),f.setAttribute("href",h),w.removeClass().addClass(H+" dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),w.find(".dlm-xhr-error").remove(),w.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},dlmXHRinstance.request.open("GET",h,!0),dlmXHRinstance.request.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),dlmXHRinstance.request.send()}dlmLogDownload(e,d,o,t=null,l=null,n="_self"){null!==l?window.location.href=t:(l=window.location.href,d={download_id:void 0!==e["x-dlm-download-id"]?e["x-dlm-download-id"]:e["dlm-download-id"],version_id:void 0!==e["x-dlm-version-id"]?e["x-dlm-version-id"]:e["dlm-version-id"],status:d,cookie:o,currentURL:l,action:"log_dlm_xhr_download",responseHeaders:e,nonce:this.xhrNonce},jQuery.post(dlmXHR.ajaxUrl,d,function(e){null!==t&&(null==n&&(n="_self"),window.open(t,n))}))}dlmNoAccessModal(e){let d="empty-download",o="empty-version",t="empty-restriction",l="",n=(void 0!==e["dlm-download-id"]&&(d=e["dlm-download-id"]),void 0!==e["dlm-version-id"]&&(o=e["dlm-version-id"]),void 0!==e["dlm-no-access-modal-text"]&&(l=e["dlm-no-access-modal-text"]),void 0!==e["dlm-no-access-restriction"]&&(t=e["dlm-no-access-restriction"]),void 0!==e["x-dlm-download-id"]&&(d=e["x-dlm-download-id"]),void 0!==e["x-dlm-version-id"]&&(o=e["x-dlm-version-id"]),void 0!==e["x-dlm-no-access-modal-text"]&&(l=e["x-dlm-no-access-modal-text"]),void 0!==e["x-dlm-no-access-restriction"]&&(t=e["x-dlm-no-access-restriction"]),{download_id:d,version_id:o,modal_text:l,restriction:t,action:"no_access_dlm_xhr_download",nonce:this.xhrNonce});jQuery(document).trigger("dlm-xhr-modal-data",[n,e]),jQuery.post(dlmXHR.ajaxUrl,n,function(e){jQuery("#dlm-no-access-modal").remove(),jQuery("body").append(e),jQuery(document).trigger(n.action,[e,n])})}dlmExternalDownload(e,t,l,n,r){const s=new XMLHttpRequest;l.attr("target");let a=l.attr("class"),i,d="";void 0!==e["dlm-external-download"]&&(d=e["dlm-external-download"]),void 0!==e["x-dlm-external-download"]&&(d=e["x-dlm-external-download"]),a=void 0!==a&&""!==a?a.replace("dlm-download-started","").replace("dlm-download-completed",""):"",l.addClass("dlm-download-started"),t.setAttribute("href","#"),t.removeAttribute("download"),t.setAttribute("disabled","disabled"),jQuery(document).trigger("dlm_download_triggered",[this,t,l,i,s]),s.responseType="blob",s.onreadystatechange=function(){var{status:e,readyState:d}=s,o=s.getAllResponseHeaders().split("\r\n").reduce((e,d)=>{var[d,o]=d.split(": ");return e[d]=o,e},{});if(403===e)return dlmXHRinstance.dlmLogDownload(o,"failed",!1),s.abort(),l.find(".dlm-xhr-error").remove(),void l.append('<span class="dlm-xhr-error">Acces Denied to file.</span>');200==e&&4==d&&(e=s.response,i=URL.createObjectURL(e),t.removeEventListener("click",dlmXHRinstance.handleDownloadClick),t.setAttribute("download",""+n),t.setAttribute("href",i),t.click(),l.removeClass().addClass(a+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,t,l,i]),dlmXHRinstance.dlmLogDownload(o,"completed",!1),window.URL.revokeObjectURL(i),t.removeAttribute("download"),t.setAttribute("href",r),l.find(".dlm-xhr-loading-gif").remove(),setTimeout(function(){l.removeClass().addClass(a).find("span.dlm-xhr-progress").remove()},1e3))},s.addEventListener("progress",function(e){let d=e.loaded/e.total*100;d=d.toFixed();var o;l.find("span.dlm-xhr-progress").remove(),o="dlm-download-started download-"+10*Math.ceil(d/10),1/0!=d&&l.append('<span class="dlm-xhr-progress">&nbsp;'+d+"%</span>"),l.removeClass().addClass(a+" "+o),jQuery(document).trigger("dlm_download_progress",[this,t,l,i,e,d])}),s.onerror=function(){t.removeAttribute("download"),t.setAttribute("href",r),l.removeClass().addClass(a+" .dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),l.find(".dlm-xhr-error").remove(),l.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},s.open("GET",d,!0),s.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),s.send()}}
